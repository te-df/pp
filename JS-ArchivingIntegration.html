<!--============================================================================-->

<script>

/* * ============================================================================
 * ARCHIVING INTEGRATION - JAVASCRIPT
 * ============================================================================
 * Funções JavaScript para integrar sistema de arquivamento com frontend
 * Inclua este arquivo em suas páginas principais
 * 
 * Versão: 1.0
 * Data: 2025-10-20
 * ============================================================================ */

/* * Namespace global para funções de arquivamento */
window.ArchivingAPI = {
  
  /* * Obtém status atual do sistema */
  getStatus: function(callback) {
    google.script.run
      .withSuccessHandler(callback)
      .withFailureHandler(error => {
        console.error('Erro ao obter status:', error);
        callback({ success: false, error: error.message });
      })
      .getArchivingStatus();
  },
  
  /* * Obtém apenas tamanho do dataset (leve) */
  getDatasetSize: function(callback) {
    google.script.run
      .withSuccessHandler(callback)
      .withFailureHandler(error => {
        console.error('Erro ao obter tamanho:', error);
        callback({ success: false, error: error.message });
      })
      .getDatasetSize();
  },
  
  /* * Lista arquivos históricos */
  listArchives: function(callback) {
    google.script.run
      .withSuccessHandler(callback)
      .withFailureHandler(error => {
        console.error('Erro ao listar arquivos:', error);
        callback({ success: false, error: error.message });
      })
      .listArchivedFiles();
  },
  
  /* * Obtém status dos triggers */
  getTriggers: function(callback) {
    google.script.run
      .withSuccessHandler(callback)
      .withFailureHandler(error => {
        console.error('Erro ao obter triggers:', error);
        callback({ success: false, error: error.message });
      })
      .getTriggerStatus();
  },
  
  /* * Executa limpeza manual */
  cleanupNow: function(callback) {
    if (!confirm('Executar limpeza manual agora?\n\nIsso irá arquivar e limpar dados conforme política de retenção.')) {
      return;
    }
    
    google.script.run
      .withSuccessHandler(callback)
      .withFailureHandler(error => {
        console.error('Erro ao executar limpeza:', error);
        callback({ success: false, error: error.message });
      })
      .executeManualCleanup();
  },
  
  /* * Executa apenas arquivamento (sem limpar) */
  archiveNow: function(callback) {
    if (!confirm('Executar arquivamento manual agora?\n\nIsso irá criar um backup dos dados temporários.')) {
      return;
    }
    
    google.script.run
      .withSuccessHandler(callback)
      .withFailureHandler(error => {
        console.error('Erro ao executar arquivamento:', error);
        callback({ success: false, error: error.message });
      })
      .executeManualArchive();
  },
  
  /* * Obtém políticas de retenção */
  getRetentionPolicies: function(callback) {
    google.script.run
      .withSuccessHandler(callback)
      .withFailureHandler(error => {
        console.error('Erro ao obter políticas:', error);
        callback({ success: false, error: error.message });
      })
      .getRetentionPolicies();
  },
  
  /* * Configura triggers automáticos */
  setupTriggers: function(callback) {
    if (!confirm('Configurar triggers automáticos?\n\nIsso irá ativar:\n- Limpeza diária (2h)\n- Relatório semanal (domingo 23h)\n- Backup mensal (dia 1 às 1h)')) {
      return;
    }
    
    google.script.run
      .withSuccessHandler(callback)
      .withFailureHandler(error => {
        console.error('Erro ao configurar triggers:', error);
        callback({ success: false, error: error.message });
      })
      .setupTriggersViaAPI();
  },
  
  /* * Remove todos os triggers */
  removeTriggers: function(callback) {
    if (!confirm('Remover TODOS os triggers automáticos?\n\nIsso irá desativar todas as automações.')) {
      return;
    }
    
    google.script.run
      .withSuccessHandler(callback)
      .withFailureHandler(error => {
        console.error('Erro ao remover triggers:', error);
        callback({ success: false, error: error.message });
      })
      .removeAllTriggersViaAPI();
  },
  
  /* * Obtém estatísticas do Drive */
  getDriveStats: function(callback) {
    google.script.run
      .withSuccessHandler(callback)
      .withFailureHandler(error => {
        console.error('Erro ao obter stats do Drive:', error);
        callback({ success: false, error: error.message });
      })
      .getDriveUsageStats();
  }
};

/* * Funções auxiliares de formatação */
window.ArchivingUtils = {
  
  /* * Formata número com separadores */
  formatNumber: function(num) {
    return new Intl.NumberFormat('pt-BR').format(num);
  },
  
  /* * Formata data */
  formatDate: function(dateStr) {
    if (!dateStr) return 'N/A';
    const date = new Date(dateStr);
    return date.toLocaleString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  },
  
  /* * Formata bytes para MB */
  formatBytes: function(bytes) {
    return (bytes / (1024 * 1024)).toFixed(2);
  },
  
  /* * Calcula porcentagem */
  calculatePercent: function(value, max) {
    return Math.min((value / max) * 100, 100).toFixed(1);
  },
  
  /* * Mostra toast de notificação */
  showToast: function(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
      <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  },
  
  /* * Mostra loading overlay */
  showLoading: function(message = 'Carregando...') {
    const overlay = document.createElement('div');
    overlay.id = 'loadingOverlay';
    overlay.className = 'loading-overlay';
    overlay.innerHTML = `
      <div class="loading-content">
        <div class="spinner"></div>
        <div>${message}</div>
      </div>
    `;
    
    document.body.appendChild(overlay);
  },
  
  /* * Esconde loading overlay */
  hideLoading: function() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.remove();
  }
};

/* * Widget de status compacto para header/dashboard */
window.ArchivingWidget = {
  
  /* * Cria widget de status compacto */
  create: function(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = `
      <div  class="flex items-center" style="gap: 16px; padding: 12px 16px; background: rgba(255,255,255,0.1); border-radius: 8px">
        <div  class="flex items-center" style="gap: 8px">
          <i class="fas fa-database"  style="color: white"></i>
          <span  class="font-semibold" style="color: white; font-size: 14px">Dataset:</span>
          <span id="widgetSize-1"  style="color: white; font-weight: 700">---</span>
        </div>
        <div  class="flex items-center" style="gap: 8px">
          <i class="fas fa-chart-line"  style="color: white"></i>
          <span id="widgetRecords-1"  style="color: white; font-weight: 700">---</span>
        </div>
        <div id="widgetStatus-1"  style="width: 12px; height: 12px; border-radius: 50%; background: #10b981"></div>
      </div>
    `;
    
    // Atualiza dados
    this.update();
    
    // Auto-refresh a cada 60 segundos
    setInterval(() => this.update(), 60000);
  },
  
  /* * Atualiza widget */
  update: function() {
    ArchivingAPI.getDatasetSize(response => {
      if (!response.success) return;
      
      const data = response.data;
      const sizeEl = document.getElementById('widgetSize');
      const recordsEl = document.getElementById('widgetRecords');
      const statusEl = document.getElementById('widgetStatus');
      
      if (sizeEl) sizeEl.textContent = data.totalSizeMB + ' MB';
      if (recordsEl) recordsEl.textContent = ArchivingUtils.formatNumber(data.totalRecords);
      
      // Atualiza cor do status
      if (statusEl) {
        const sizeMB = parseFloat(data.totalSizeMB);
        if (sizeMB > 50) {
          statusEl.style.background = '#ef4444'; // Crítico
        } else if (sizeMB > 20) {
          statusEl.style.background = '#f59e0b'; // Atenção
        } else {
          statusEl.style.background = '#10b981'; // OK
        }
      }
    });
  }
};

console.log('✅ Archiving Integration carregado');

</script>

<style>
@keyframes slideOut {
  to {
    transform: translateX(400px);
    opacity: 0;
  }
}
</style>



<!--============================================================================-->