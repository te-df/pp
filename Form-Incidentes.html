<!-- Form-Incidentes.html - Fragmento de formul√°rio inclu√≠do no index.html -->
<div class="form-container">

  <!-- Alerta: Import√¢ncia do Protocolo -->
  <div class="alert alert-warning mb-4" role="alert">
    <i class="fas fa-exclamation-triangle"></i>
    <div>
      <strong>Protocolo de Incidentes - Registro Obrigat√≥rio:</strong>
      <p class="mt-2" style="font-size: 0.9rem">
        Todo incidente envolvendo seguran√ßa de estudantes, falhas operacionais ou problemas de manuten√ß√£o deve ser 
        registrado imediatamente. O registro completo √© essencial para a gest√£o de riscos e pode ser solicitado 
        pela GCOTE, TCB ou √≥rg√£os de controle. Incidentes de alta gravidade exigem comunica√ß√£o imediata √† coordena√ß√£o.
      </p>
    </div>
  </div>

  <form id="form-incidentes" class="card-body">
    
    <fieldset>
      <legend class="section-title-standardized"><i class="fas fa-clipboard-list"></i> Dados do Incidente</legend>
      <div class="w-full form-grid">
        
        <div class="form-group">
          <label for="data_hora" class="form-label">Data e Hora *</label>
          <input type="datetime-local" class="form-control" id="data_hora" name="Data_Hora" required>
          <small class="form-help-text">Data e hora em que o incidente ocorreu</small>
        </div>

        <div class="form-group">
          <label for="tipo" class="form-label">Tipo de Incidente *</label>
          <select class="form-control" id="incidentes-tipo" name="Tipo" required>
            <option value="">Selecione...</option>
            <option value="Seguran√ßa">üö® Seguran√ßa</option>
            <option value="Operacional">‚öôÔ∏è Operacional</option>
            <option value="Manuten√ß√£o">üîß Manuten√ß√£o</option>
            <option value="Disciplinar">üìã Disciplinar</option>
            <option value="Outros">üìù Outros</option>
          </select>
        </div>

        <div class="form-group">
          <label for="gravidade" class="form-label">Gravidade *</label>
          <select class="form-control" id="gravidade" name="Gravidade" required onchange="validarGravidade()">
            <option value="">Selecione...</option>
            <option value="Baixa">üü¢ Baixa</option>
            <option value="M√©dia">üü° M√©dia</option>
            <option value="Alta">üü† Alta</option>
            <option value="Cr√≠tica">üî¥ Cr√≠tica</option>
          </select>
        </div>

        <div class="form-group">
          <label for="status" class="form-label">Status *</label>
          <select class="form-control" id="incidentes-status" name="Status" required>
            <option value="Pendente" selected>Pendente</option>
            <option value="Em An√°lise">Em An√°lise</option>
            <option value="Resolvido">Resolvido</option>
            <option value="Arquivado">Arquivado</option>
          </select>
        </div>

        <div class="form-group" style="grid-column: 1 / -1">
          <label for="descricao" class="form-label">Descri√ß√£o do Incidente * <span style="color: var(--md-sys-color-error)">(m√≠nimo 20 caracteres)</span></label>
          <textarea class="form-control" id="incidentes-descricao" name="Descricao" rows="4" 
                    placeholder="Descreva detalhadamente o que aconteceu, quando, onde e quem estava envolvido..." 
                    required minlength="20"></textarea>
          <small class="form-help-text">Seja espec√≠fico e objetivo. Inclua nomes, hor√°rios e contexto.</small>
        </div>

        <div class="form-group">
          <label for="responsavel" class="form-label">Respons√°vel pelo Registro *</label>
          <input type="text" class="form-control" id="responsavel" name="Responsavel" required readonly>
          <small class="form-help-text">Usu√°rio que est√° registrando o incidente</small>
        </div>

      </div>
    </fieldset>

    <!-- Alerta din√¢mico para incidentes cr√≠ticos -->
    <div class="alert alert-danger mb-4" role="alert" id="alerta-critico" style="display: none;">
      <i class="fas fa-exclamation-circle"></i>
      <div>
        <strong>‚ö†Ô∏è INCIDENTE CR√çTICO IDENTIFICADO</strong>
        <p class="mt-2" style="font-size: 0.9rem">
          Incidentes de gravidade ALTA ou CR√çTICA exigem comunica√ß√£o imediata √† coordena√ß√£o da GCOTE. 
          Ap√≥s salvar este registro, entre em contato com o gestor respons√°vel e documente todas as a√ß√µes tomadas.
        </p>
      </div>
    </div>

    <div class="card-footer">
      <button type="button" class="btn btn-secondary" onclick="limparFormulario()">
        <i class="fas fa-eraser"></i> Limpar
      </button>
      <button type="submit" class="btn btn-primary" id="btn-salvar-incidente">
        <i class="fas fa-save"></i> Registrar Incidente
      </button>
    </div>

  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  console.log('[Form-Incidentes] Inicializando formul√°rio');
  
  // Define data/hora atual como padr√£o
  const agora = new Date();
  const dataHoraLocal = agora.toISOString().slice(0, 16); // Remove segundos
  document.getElementById('data_hora').value = dataHoraLocal;
  
  // Define respons√°vel como usu√°rio logado
  if (window.AuthManager && window.AuthManager.currentUser) {
    document.getElementById('responsavel').value = window.AuthManager.currentUser.username || 'Operador';
  } else {
    document.getElementById('responsavel').value = 'Operador';
  }
  
  // Configura submit universal do formul√°rio
  if (window.UniversalFormSubmit) {
    window.UniversalFormSubmit.setup('form-incidentes', 'Incidentes', {
      successMessage: 'Incidente registrado com sucesso!',
      clearFormAfterSuccess: true,
      onSuccess: async (result) => {
        console.log('[Form-Incidentes] Incidente salvo:', result);
        
        // Reseta data/hora para agora
        const agora = new Date();
        document.getElementById('data_hora').value = agora.toISOString().slice(0, 16);
        
        // Oculta alerta cr√≠tico
        document.getElementById('alerta-critico').style.display = 'none';
      },
      beforeSubmit: async (form) => {
        // Valida√ß√£o: descri√ß√£o m√≠nima de 20 caracteres
        const descricao = document.getElementById('descricao').value.trim();
        if (descricao.length < 20) {
          if (window.ToastManager) {
            window.ToastManager.show(
              'A descri√ß√£o do incidente deve ter no m√≠nimo 20 caracteres.',
              'warning'
            );
          }
          return false;
        }
        
        // Valida√ß√£o: data/hora n√£o pode ser futura
        const dataHora = new Date(document.getElementById('data_hora').value);
        const agora = new Date();
        if (dataHora > agora) {
          if (window.ToastManager) {
            window.ToastManager.show(
              'A data/hora do incidente n√£o pode ser futura.',
              'warning'
            );
          }
          return false;
        }
        
        // Confirma gravidade cr√≠tica
        const gravidade = document.getElementById('gravidade').value;
        if (gravidade === 'Cr√≠tica') {
          const confirmacao = confirm(
            '‚ö†Ô∏è ATEN√á√ÉO: Voc√™ est√° registrando um incidente CR√çTICO.\n\n' +
            'Isso exige:\n' +
            '1. Comunica√ß√£o imediata √† coordena√ß√£o\n' +
            '2. Documenta√ß√£o detalhada de todas a√ß√µes\n' +
            '3. Acompanhamento at√© resolu√ß√£o\n\n' +
            'Confirma o registro?'
          );
          if (!confirmacao) {
            return false;
          }
        }
        
        return true;
      }
    });
  }
  
  console.log('[Form-Incidentes] Formul√°rio inicializado com sucesso');
});

// Valida gravidade e exibe alerta se cr√≠tico
function validarGravidade() {
  const gravidade = document.getElementById('gravidade').value;
  const alertaCritico = document.getElementById('alerta-critico');
  
  if (gravidade === 'Alta' || gravidade === 'Cr√≠tica') {
    alertaCritico.style.display = 'block';
  } else {
    alertaCritico.style.display = 'none';
  }
}

// Limpa o formul√°rio
function limparFormulario() {
  const form = document.getElementById('form-incidentes');
  if (form) {
    form.reset();
    
    // Reseta data/hora para agora
    const agora = new Date();
    document.getElementById('data_hora').value = agora.toISOString().slice(0, 16);
    
    // Reseta respons√°vel
    if (window.AuthManager && window.AuthManager.currentUser) {
      document.getElementById('responsavel').value = window.AuthManager.currentUser.username || 'Operador';
    }
    
    // Oculta alerta cr√≠tico
    document.getElementById('alerta-critico').style.display = 'none';
    
    // Remove modo edi√ß√£o
    delete form.dataset.editingId;
    
    // Reseta bot√£o
    const btn = document.getElementById('btn-salvar-incidente');
    if (btn) {
      btn.innerHTML = '<i class="fas fa-save"></i> Registrar Incidente';
    }
  }
}
</script>
