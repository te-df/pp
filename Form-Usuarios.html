<!-- Form-Usuarios.html - Fragmento de formul√°rio inclu√≠do no index.html -->
<div class="form-container">

  <!-- Alerta: Gest√£o de Acessos -->
  <div class="alert alert-info mb-4" role="alert">
    <i class="fas fa-shield-alt"></i>
    <div>
      <strong>Gest√£o de Usu√°rios e Controle de Acesso:</strong>
      <p class="mt-2" style="font-size: 0.9rem">
        O cadastro de usu√°rios define as permiss√µes de acesso ao sistema. Apenas administradores podem criar novos usu√°rios. 
        Mantenha os dados atualizados e desative imediatamente usu√°rios que n√£o devem mais ter acesso. 
        Senhas devem ter no m√≠nimo 8 caracteres, incluindo letras mai√∫sculas e n√∫meros.
      </p>
    </div>
  </div>

  <form id="form-usuarios" class="card-body">
    
    <fieldset>
      <legend class="section-title-standardized"><i class="fas fa-user-circle"></i> Dados do Usu√°rio</legend>
      <div class="w-full form-grid">
        
        <div class="form-group">
          <label for="username" class="form-label">Nome de Usu√°rio * <span style="color: var(--md-sys-color-error)">(4-20 caracteres)</span></label>
          <input type="text" class="form-control" id="username" name="Username" 
                 placeholder="Ex: joao.silva" 
                 required minlength="4" maxlength="20" 
                 pattern="[a-zA-Z0-9._-]+" 
                 title="Apenas letras, n√∫meros, pontos, h√≠fens e underscores">
          <small class="form-help-text">Alfanum√©rico, sem espa√ßos. √önico no sistema.</small>
        </div>

        <div class="form-group">
          <label for="email" class="form-label">E-mail *</label>
          <input type="email" class="form-control" id="usuarios-email" name="Email" 
                 placeholder="usuario@sigte.df.gov.br" 
                 required>
          <small class="form-help-text">E-mail institucional v√°lido. √önico no sistema.</small>
        </div>

        <div class="form-group" id="password-group">
          <label for="password" class="form-label">Senha * <span style="color: var(--md-sys-color-error)">(m√≠n. 8 caracteres)</span></label>
          <div style="position: relative;">
            <input type="password" class="form-control" id="password" name="Password" 
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                   minlength="8" 
                   pattern="(?=.*[A-Z])(?=.*\d).{8,}" 
                   title="M√≠nimo 8 caracteres, 1 mai√∫scula e 1 n√∫mero">
            <button type="button" class="btn btn-icon" 
                    style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;" 
                    onclick="togglePasswordVisibility()" 
                    title="Mostrar/Ocultar senha">
              <i class="fas fa-eye" id="toggle-password-icon"></i>
            </button>
          </div>
          <small class="form-help-text">M√≠nimo 8 caracteres, incluindo 1 letra mai√∫scula e 1 n√∫mero</small>
        </div>

        <div class="form-group">
          <label for="role" class="form-label">Perfil de Acesso *</label>
          <select class="form-control" id="role" name="Role" required onchange="exibirPermissoes()">
            <option value="">Selecione...</option>
            <option value="Admin">üëë Administrador (acesso total)</option>
            <option value="Operador">‚öôÔ∏è Operador (gest√£o operacional)</option>
            <option value="Visualizador">üëÅÔ∏è Visualizador (somente leitura)</option>
            <option value="Monitor">üöå Monitor (frequ√™ncia e rotas)</option>
          </select>
        </div>

        <div class="form-group">
          <label for="status" class="form-label">Status *</label>
          <select class="form-control" id="usuarios-status" name="Status" required>
            <option value="Ativo" selected>‚úÖ Ativo</option>
            <option value="Inativo">‚ùå Inativo</option>
            <option value="Suspenso">‚è∏Ô∏è Suspenso</option>
          </select>
        </div>

      </div>
    </fieldset>

    <!-- Informa√ß√µes de Permiss√µes (din√¢mico) -->
    <div class="alert alert-secondary mb-4" role="alert" id="permissoes-info" style="display: none;">
      <i class="fas fa-info-circle"></i>
      <div id="permissoes-texto">
        <!-- Conte√∫do din√¢mico baseado no perfil -->
      </div>
    </div>

    <div class="card-footer">
      <button type="button" class="btn btn-secondary" onclick="limparFormulario()">
        <i class="fas fa-eraser"></i> Limpar
      </button>
      <button type="submit" class="btn btn-primary" id="btn-salvar-usuario">
        <i class="fas fa-user-plus"></i> Cadastrar Usu√°rio
      </button>
    </div>

  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  console.log('[Form-Usuarios] Inicializando formul√°rio');
  
  // Configura submit universal do formul√°rio
  if (window.UniversalFormSubmit) {
    window.UniversalFormSubmit.setup('form-usuarios', 'Usuarios', {
      successMessage: 'Usu√°rio cadastrado com sucesso!',
      clearFormAfterSuccess: true,
      onSuccess: async (result) => {
        console.log('[Form-Usuarios] Usu√°rio salvo:', result);
      },
      beforeSubmit: async (form) => {
        // Valida√ß√£o: username alfanum√©rico e √∫nico
        const username = document.getElementById('username').value.trim();
        const usernameRegex = /^[a-zA-Z0-9._-]{4,20}$/;
        if (!usernameRegex.test(username)) {
          if (window.ToastManager) {
            window.ToastManager.show(
              'Nome de usu√°rio inv√°lido. Use apenas letras, n√∫meros, pontos, h√≠fens e underscores (4-20 caracteres).',
              'warning'
            );
          }
          return false;
        }
        
        // Valida√ß√£o: e-mail v√°lido
        const email = document.getElementById('email').value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          if (window.ToastManager) {
            window.ToastManager.show(
              'E-mail inv√°lido. Insira um endere√ßo de e-mail v√°lido.',
              'warning'
            );
          }
          return false;
        }
        
        // Valida√ß√£o: senha forte (apenas em modo cria√ß√£o)
        const passwordField = document.getElementById('password');
        if (!form.dataset.editingId && passwordField) {
          const password = passwordField.value;
          const passwordRegex = /^(?=.*[A-Z])(?=.*\d).{8,}$/;
          if (!passwordRegex.test(password)) {
            if (window.ToastManager) {
              window.ToastManager.show(
                'Senha fraca. A senha deve ter no m√≠nimo 8 caracteres, incluindo 1 letra mai√∫scula e 1 n√∫mero.',
                'warning'
              );
            }
            return false;
          }
          
          // Hash a senha antes de enviar (simulado aqui - na pr√°tica deve ser hash no backend)
          // No backend, usar CryptoJS.SHA256(password).toString() ou similar
          form.querySelector('[name="Password_Hash"]').value = btoa(password); // Base64 simples (substituir por hash real)
        }
        
        return true;
      }
    });
  }
  
  console.log('[Form-Usuarios] Formul√°rio inicializado com sucesso');
});

// Toggle visibilidade da senha
function togglePasswordVisibility() {
  const passwordField = document.getElementById('password');
  const icon = document.getElementById('toggle-password-icon');
  
  if (passwordField.type === 'password') {
    passwordField.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    passwordField.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

// Exibe informa√ß√µes de permiss√µes baseado no perfil
function exibirPermissoes() {
  const role = document.getElementById('role').value;
  const permissoesDiv = document.getElementById('permissoes-info');
  const permissoesTexto = document.getElementById('permissoes-texto');
  
  const permissoes = {
    'Admin': '<strong>Administrador - Acesso Total:</strong><ul><li>Gest√£o completa do sistema</li><li>Cadastro de usu√°rios</li><li>Configura√ß√µes avan√ßadas</li><li>Relat√≥rios e auditoria</li></ul>',
    'Operador': '<strong>Operador - Gest√£o Operacional:</strong><ul><li>Cadastro de alunos, rotas e incidentes</li><li>Registro de frequ√™ncia</li><li>Visualiza√ß√£o de relat√≥rios</li><li>Sem acesso a usu√°rios e configura√ß√µes</li></ul>',
    'Visualizador': '<strong>Visualizador - Somente Leitura:</strong><ul><li>Visualiza√ß√£o de dados</li><li>Consulta de relat√≥rios</li><li>Sem permiss√£o de edi√ß√£o ou cria√ß√£o</li></ul>',
    'Monitor': '<strong>Monitor - Frequ√™ncia e Rotas:</strong><ul><li>Registro de frequ√™ncia de alunos</li><li>Visualiza√ß√£o de rotas</li><li>Registro de incidentes leves</li><li>Sem acesso a configura√ß√µes</li></ul>'
  };
  
  if (role && permissoes[role]) {
    permissoesTexto.innerHTML = permissoes[role];
    permissoesDiv.style.display = 'block';
  } else {
    permissoesDiv.style.display = 'none';
  }
}

// Limpa o formul√°rio
function limparFormulario() {
  const form = document.getElementById('form-usuarios');
  if (form) {
    form.reset();
    
    // Oculta permiss√µes
    document.getElementById('permissoes-info').style.display = 'none';
    
    // Remove modo edi√ß√£o
    delete form.dataset.editingId;
    
    // Reseta bot√£o
    const btn = document.getElementById('btn-salvar-usuario');
    if (btn) {
      btn.innerHTML = '<i class="fas fa-user-plus"></i> Cadastrar Usu√°rio';
    }
    
    // Mostra campo senha novamente (caso tenha sido ocultado em modo edi√ß√£o)
    document.getElementById('password-group').style.display = 'block';
  }
}
</script>
