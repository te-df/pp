<!--============================================================================-->

<script>
/**
 * ============================================================================
 * AUTH MANAGER ENHANCED - Sistema de AutenticaÃ§Ã£o com Backend Real
 * ============================================================================
 * Carrega usuÃ¡rios das planilhas 'Usuarios' e 'Pessoal' via DataLoader
 * MantÃ©m compatibilidade com usuÃ¡rios demo para desenvolvimento
 * ============================================================================
 */
(function() {
    'use strict';

    const AuthManagerEnhanced = {
        async loadUsersFromBackend() {
            try {
                console.log('[AuthEnhanced] ðŸ“¥ Carregando usuÃ¡rios do backend...');
                
                // Verificar se DataLoader estÃ¡ disponÃ­vel
                if (typeof window.DataLoader === 'undefined') {
                    console.warn('[AuthEnhanced] âš ï¸ DataLoader nÃ£o disponÃ­vel, usando demo users');
                    return false;
                }

                // Carregar usuÃ¡rios de ambas as planilhas em paralelo
                const [usuarios, pessoal] = await Promise.all([
                    window.DataLoader.load('Usuarios', {}, false).catch(e => {
                        console.warn('[AuthEnhanced] NÃ£o foi possÃ­vel carregar "Usuarios":', e.message);
                        return [];
                    }),
                    window.DataLoader.load('Pessoal', {}, false).catch(e => {
                        console.warn('[AuthEnhanced] NÃ£o foi possÃ­vel carregar "Pessoal":', e.message);
                        return [];
                    })
                ]);
                
                const allUsers = [];
                let usuariosCount = 0;
                let pessoalCount = 0;

                // Mapear usuÃ¡rios da planilha 'Usuarios'
                usuarios.forEach(user => {
                    const mapped = this.mapUsuario(user);
                    if (mapped) {
                        allUsers.push(mapped);
                        usuariosCount++;
                    }
                });

                // Mapear usuÃ¡rios da planilha 'Pessoal' (Motoristas/Monitores)
                pessoal.forEach(user => {
                    const mapped = this.mapPessoal(user);
                    if (mapped) {
                        allUsers.push(mapped);
                        pessoalCount++;
                    }
                });

                console.log(`[AuthEnhanced] ðŸ“Š UsuÃ¡rios mapeados: ${usuariosCount} de Usuarios + ${pessoalCount} de Pessoal = ${allUsers.length} total`);

                if (allUsers.length === 0) {
                    console.warn('[AuthEnhanced] âš ï¸ Nenhum usuÃ¡rio encontrado no backend (Usuarios ou Pessoal)');
                    return false;
                }

                // Converter para formato do AuthManager
                const backendUsers = {};
                allUsers.forEach(user => {
                    if (user && user.username) {
                        backendUsers[user.username] = user;
                    }
                });

                // Atualizar demoUsers do AuthManager com dados do backend
                if (window.AuthManager && Object.keys(backendUsers).length > 0) {
                    // Mesclar: manter demo users e adicionar backend users
                    window.AuthManager.demoUsers = {
                        ...window.AuthManager.demoUsers,
                        ...backendUsers
                    };
                    
                    console.log('[AuthEnhanced] âœ… UsuÃ¡rios carregados:', Object.keys(backendUsers).length);
                    console.log('[AuthEnhanced] ðŸ“‹ UsuÃ¡rios disponÃ­veis:', Object.keys(window.AuthManager.demoUsers));
                    return true;
                }

                return false;

            } catch (error) {
                console.error('[AuthEnhanced] âŒ Erro ao carregar usuÃ¡rios:', error);
                return false;
            }
        },

        /**
         * Mapeia um registro da planilha 'Usuarios' para o formato de usuÃ¡rio.
         */
        mapUsuario(user) {
            const username = user.Username || user.Email; // Usar Email como fallback para username
            if (!username) return null;

            return {
                username: username,
                password: user.Password_Hash || '', // O hash Ã© tratado no login
                role: user.Role || 'Visualizador',
                nome: user.Username,
                email: user.Email || '',
                permissions: this.parsePermissions(user.Permissions || ''),
                ativo: user.Status === 'Ativo'
            };
        },

        /**
         * Mapeia um registro da planilha 'Pessoal' para o formato de usuÃ¡rio.
         */
        mapPessoal(user) {
            const username = user.Email; // Usar Email como username
            if (!username) return null;

            // Gerar senha padrÃ£o: CPF sem pontos/traÃ§os (primeiros 6 dÃ­gitos)
            const cpfLimpo = (user.CPF || '').replace(/\D/g, '');
            const senhaDefault = cpfLimpo.substring(0, 6) || 'senha123';

            // PermissÃµes especÃ­ficas por funÃ§Ã£o
            let permissions = 'frequencia:read';
            if (user.Funcao === 'Motorista') {
                permissions = 'frequencia:read,frequencia:write,incidentes:create,tracking:view';
            } else if (user.Funcao === 'Monitora' || user.Funcao === 'Monitor') {
                permissions = 'frequencia:read,frequencia:write,incidentes:create,alunos:read';
            }

            return {
                username: username,
                password: senhaDefault, // Senha padrÃ£o baseada no CPF
                role: user.Funcao || 'Operacional', // 'Motorista', 'Monitora', 'Monitor'
                nome: user.Nome_Completo || username,
                email: user.Email || '',
                permissions: this.parsePermissions(permissions),
                ativo: user.Status === 'Ativo',
                isPessoal: true, // Flag para identificar que veio da planilha Pessoal
                cpf: user.CPF || '',
                telefone: user.Telefone || '',
                idRota: user.ID_Rota_Associada || ''
            };
        },
        /**
         * Converte string de permissÃµes em array
         */
        parsePermissions(permissionsStr) {
            if (!permissionsStr) return [];
            if (permissionsStr === '*') return ['*'];
            
            // Suporta: "read,write" ou "module:read,module:write"
            return permissionsStr
                .split(',')
                .map(p => p.trim())
                .filter(p => p.length > 0);
        },

        /**
         * Inicializa o sistema enhanced
         */
        async init() {
            console.log('[AuthEnhanced] ðŸš€ Inicializando sistema enhanced...');
            
            // Aguardar AuthManager estar disponÃ­vel
            if (typeof window.AuthManager === 'undefined') {
                console.warn('[AuthEnhanced] âš ï¸ AuthManager nÃ£o disponÃ­vel ainda, aguardando...');
                await this.waitForAuthManager();
            }

            // Carregar usuÃ¡rios do backend
            await this.loadUsersFromBackend();

            // Atualizar a cada 5 minutos
            setInterval(() => {
                this.loadUsersFromBackend();
            }, 5 * 60 * 1000);

            console.log('[AuthEnhanced] âœ… Sistema enhanced ativo!');
        },

        /**
         * Aguarda AuthManager ficar disponÃ­vel
         */
        async waitForAuthManager(timeout = 5000) {
            const startTime = Date.now();
            
            while (typeof window.AuthManager === 'undefined') {
                if (Date.now() - startTime > timeout) {
                    throw new Error('Timeout esperando AuthManager');
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
    };

    // Inicializar apÃ³s DOM e DataLoader estarem prontos
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            // Aguardar um pouco para garantir que outros scripts carreguem
            setTimeout(() => AuthManagerEnhanced.init(), 500);
        });
    } else {
        setTimeout(() => AuthManagerEnhanced.init(), 500);
    }

    // Expor globalmente
    window.AuthManagerEnhanced = AuthManagerEnhanced;

    console.log('[AuthEnhanced] ðŸ“¦ Script carregado');

})();
</script>


<!--============================================================================-->
